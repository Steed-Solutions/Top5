{% extends 'site/base.html' %} {% load static %} {% block content %}

<title>Post - {{ post.name }}</title>

<div id="selectedPost">
  <img
    id="closePostBtn"
    src="{% static 'img/next_btn.png' %}"
    onclick="window.history.back();"
  />
  <div id="selectedPostTitle">{{ post.name }}</div>
  <div id="selectedPostContent">
    {% if "img" in post.type %}
    <img id="postImageOrVideo" src="{{ post.link }}" />
    {% elif "vid" in post.type %}
    <video id="postImageOrVideo" src="{{ post.link }}" controls></video>
    {% endif %} {% if "txt" in post.type|lower or post.type == "article" %}
    <pre style="white-space: normal"></pre>
    {% endif %}
  </div>

  <div id="selectedPostActionAndComments">
    <div class="post_action">
      <div class="post_action_item" name="like_{{ post.id }}">
        <span
          class="{% if post.isLiked %}fas{% else %}far{% endif %} fa-heart"
          style="{% if post.isLiked %}color: #D7443E{% endif %}"
        >
        </span>
        <span>{{ post.likes }} like{% if post.likes != 1 %}s{% endif %}</span>
      </div>
      <div class="post_action_item" id="comments_count_{{ post.id }}">
        <span class="far fa-comment"> </span>
        <span
          >{{ post.comments }} comment{% if post.comments != 1 %}s{% endif %}
        </span>
      </div>

      <div
        class="post_action_item"
        name="save_{{ post.id }}"
        data-category-id="{{ post.category.id }}"
      >
        <span
          class="{% if post.isSaved %}fas{% else %}far{% endif %} fa-bookmark"
        >
        </span>
      </div>
    </div>
    <div class="comment_sec">
      <div class="likes">
        <div class="user_pic">
          <img src="{% static 'img/user_avatar.png' %}" alt="user" />
          <img src="{% static 'img/user_avatar.png' %}" alt="user" />
          <img src="{% static 'img/user_avatar.png' %}" alt="user" />
        </div>
        <span>{{ post.likeStr }}</span>
      </div>
      <div id="comments_{{ post.id }}" class="comments">
        {% for comment in post.allComments %}
        <div id="{{ comment.id }}" class="comment">
          <img src="{% static 'img/user_avatar.png' %}" alt="user" />
          <div class="comment_content">
            <span>{{ comment.username }}</span
            ><span style="grid-column: 2/4">{{ comment.comment }}</span
            ><span class="comment_action">24h</span>
            {% if isLoggedIn %}
            <span class="comment_action">Reply</span>
            {% if userID == comment.userID %}
            <span
              class="comment_action"
              style="color: #ff5656; margin-left: 10px"
              onclick="onDeleteComment(this)"
              >Delete</span
            >
            {% endif %} {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="comment_input">
      <img src="{% static 'img/user_avatar.png' %}" alt="user" />
      <input
        id="comment_inp_{{ post.id }}"
        type="text"
        {%
        if
        isLoggedIn
        %}disabled{%
        endif
        %}
        placeholder="{% if isLoggedIn %}Enter your comment...{% else %}Login to comment...{% endif %}"
      />
      {% if isLoggedIn %}
      <button class="postBtn_{{ post.id }}">Post</button>
      {% endif %}
    </div>
  </div>

  <script>
    let selectedCommentForDeletion = "";

    function onDeleteComment(e) {
      selectedCommentForDeletion = $(e).closest(".comment").attr("id");

      $("#postCommentDeletionConfirmationModal").show();
    }

    $(document).ready(() => {
      let postMap = {{ postMap | safe }};
      const postID = postMap['id'];



      $("#selectedPostContent > pre").html(postMap['text']);

      function likePost(isLike) {
        $.ajax({
          type: "POST",
          url: "{% url 'post' 123456 %}".replace(/123456/, "{{ urlQuery | safe }}"),
          data: {
            type: "like",
            isLike: isLike,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: (response) => {
            if (response.result == "success") {
              $(
                "#selectedPostActionAndComments [name='like_" +
                  postID +
                  "'] > span:first-child"
              )
                .toggleClass("far")
                .toggleClass("fas");
              $(
                "#selectedPostActionAndComments [name='like_" +
                  postID +
                  "'] > span:first-child"
              ).css("color", isLike ? "#D7443E" : "black");
              $(
                "#selectedPostActionAndComments [name='like_" +
                  postID +
                  "'] > span:last-child"
              ).html(response.likes + " like" + (response.likes != 1 ? "s" : ""));
            }
          },
          error: (xhr, errmsg, err) => {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
        });
      }

      function addNewComment(commentID, message) {
        let comment = document.createElement("div");
        comment.classList.add("comment");
        comment.setAttribute("id", commentID);
        comment.setAttribute("data-post-id", postID);
        comment.innerHTML =
          "<img src=\"{% static 'img/user_avatar.png' %}\" alt='user' /><div class='comment_content'><span>You</span><span style='grid-column: 2/4;'>" +
          message +
          "</span><span class='comment_action' style='cursor: unset;'>24h</span>" + ("{{ isLoggedIn }}" == "True" ? "<span class='comment_action'>Reply</span><span class='comment_action' style='color:#ff5656; margin-left:10px' onclick='onDeleteComment(this)'>Delete</span>" : "") + "</div>";

        document.getElementById("comments_" + postID).appendChild(comment);
      }

      function commentOnPost(comment) {
        $.ajax({
          type: "POST",
          url: "{% url 'post' 123456 %}".replace(/123456/, "{{ urlQuery | safe }}"),
          data: {
            type: "comment",
            comment: comment,
            timestamp: new Date().getTime(),
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: (response) => {
            if (response.result == "success") {
              addNewComment(response.commentID, comment);
              $(
                "#comments_count_" +
                  postID +
                  " > span:last-child"
              ).html(
                response.comments +
                  " comment" +
                  (response.comments != 1 ? "s" : "") +
                  "</span>"
              );
              $("#comment_inp_" + postID).val("");
            }
          },
          error: (xhr, errmsg, err) => {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
        });
      }

      function deleteComment(commentID) {
        $.ajax({
          type: "POST",
          url: "{% url 'post' 123456 %}".replace(/123456/, "{{ urlQuery | safe }}"),
          data: {
            type: "delete_comment",
            commentID: commentID,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: (response) => {
            if (response.result == "success") {
              $("#" + commentID).remove()
              $(
                "#comments_count_" +
                  postID +
                  " > span:last-child"
              ).html(
                response.comments +
                  " comment" +
                  (response.comments != 1 ? "s" : "") +
                  "</span>"
              );
            } else {
              alert("Failed to delete comment!");
            }

            $("#postCommentDeletionConfirmationModal").hide();
          },
          error: (xhr, errmsg, err) => {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
        });
      }

      function savePost(categoryID, isSave) {
        $.ajax({
          type: "POST",
          url: "{% url 'post' 123456 %}".replace(/123456/, "{{ urlQuery | safe }}"),
          data: {
            type: "save",
            isSave: isSave,
            categoryID: categoryID,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: (response) => {
            if (response.result == "success") {
              $(
                "[name='save_" +
                  postID +
                  "'] > span"
              )
                .toggleClass("far")
                .toggleClass("fas");
            }
          },
          error: (xhr, errmsg, err) => {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
        });
      }

      if ("{{ isLoggedIn }}" == "True") {
        $(
          "#selectedPostActionAndComments [name='like_" + postMap["id"] + "']"
        ).click((e) => {
          likePost(
            $(
              "#selectedPostActionAndComments [name='like_" +
                postID +
                "'] > span:first-child"
            ).hasClass("far")
          );
        });

        $("#selectedPostActionAndComments .postBtn_" + postMap["id"]).click(
          (e) => {
            commentInp = $(
              "#selectedPostActionAndComments #comment_inp_" + postID
            ).val();
            commentOnPost(commentInp);
          }
        );

        $(
          "#selectedPostActionAndComments [name='save_" + postMap["id"] + "']"
        ).click((e) => {
          categoryID = $(e.target)
            .closest(".post_action_item")
            .attr("data-category-id");
          savePost(
            categoryID,
            $(
              "#selectedPostActionAndComments [name='save_" + postID + "'] > span"
            ).hasClass("far")
          );
        });

        $("#confirmCommentDeletionBtn").click(() => {
          deleteComment(selectedCommentForDeletion);
        });
      }
    });
  </script>

  {% endblock %}
</div>
