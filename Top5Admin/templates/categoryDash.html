{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ categoryID }} Dashboard</title>

    <link rel="stylesheet" href="{% static 'css/categoryDash.css' %}" />
    <link rel="stylesheet" href="{% static 'css/bootstrap_combined.css' %}" />
    <link rel="stylesheet" href="{% static 'css/prettify.css' %}" />
    <link
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <script src="{% static 'js/jquery.hotkeys.js' %}"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <link
      href="http://netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css"
      rel="stylesheet"
    />
    <script src="{% static 'js/prettify.js' %}"></script>
  </head>
  <body>
    <div id="category_dashboard" method="post" enctype="multipart/form-data">
      <div class="post_sec">
        <form id="newPostForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input id="name" type="text" placeholder="Name" required />

          <div
            class="btn-toolbar"
            data-role="post_text_toolbar"
            data-target="#postTxtArea"
            style="display: none"
          >
            <div class="btn-group">
              <a
                class="btn dropdown-toggle"
                data-toggle="dropdown"
                title="Font Size"
                ><i class="icon-text-height"></i>&nbsp;<b class="caret"></b
              ></a>
              <ul class="dropdown-menu">
                <li>
                  <a data-edit="fontSize 5"
                    ><span style="font-size: 1.26em">Huge</span></a
                  >
                </li>
                <li>
                  <a data-edit="fontSize 3"
                    ><span style="font-size: 1em">Normal</span></a
                  >
                </li>
                <li>
                  <a data-edit="fontSize 1"
                    ><span style="font-size: 0.76em">Small</span></a
                  >
                </li>
              </ul>
            </div>
            <div class="btn-group">
              <a class="btn" data-edit="bold" title="Bold (Ctrl/Cmd+B)"
                ><i class="icon-bold"></i
              ></a>
              <a class="btn" data-edit="italic" title="Italic (Ctrl/Cmd+I)"
                ><i class="icon-italic"></i
              ></a>
              <a class="btn" data-edit="strikethrough" title="Strikethrough"
                ><i class="icon-strikethrough"></i
              ></a>
              <a
                class="btn"
                data-edit="underline"
                title="Underline (Ctrl/Cmd+U)"
                ><i class="icon-underline"></i
              ></a>
            </div>
            <div class="btn-group">
              <a class="btn" data-edit="insertunorderedlist" title="Bullet list"
                ><i class="icon-list-ul"></i
              ></a>
              <a class="btn" data-edit="insertorderedlist" title="Number list"
                ><i class="icon-list-ol"></i
              ></a>
              <a
                class="btn"
                data-edit="outdent"
                title="Reduce indent (Shift+Tab)"
                ><i class="icon-indent-left"></i
              ></a>
              <a class="btn" data-edit="indent" title="Indent (Tab)"
                ><i class="icon-indent-right"></i
              ></a>
            </div>
            <div class="btn-group">
              <a
                class="btn"
                data-edit="justifyleft"
                title="Align Left (Ctrl/Cmd+L)"
                ><i class="icon-align-left"></i
              ></a>
              <a
                class="btn"
                data-edit="justifycenter"
                title="Center (Ctrl/Cmd+E)"
                ><i class="icon-align-center"></i
              ></a>
              <a
                class="btn"
                data-edit="justifyright"
                title="Align Right (Ctrl/Cmd+R)"
                ><i class="icon-align-right"></i
              ></a>
              <a
                class="btn"
                data-edit="justifyfull"
                title="Justify (Ctrl/Cmd+J)"
                ><i class="icon-align-justify"></i
              ></a>
            </div>
            <div class="btn-group">
              <div id="linkBtn" class="btn" title="Hyperlink">
                <i class="icon-link"></i>
              </div>
            </div>
            <div class="btn-group">
              <div id="embedImageBtn" class="btn" title="Image">
                <i class="fas fa-image"></i>
              </div>
              <div id="embedVideoBtn" class="btn" title="Video">
                <i class="fas fa-video"></i>
              </div>
            </div>
          </div>
          <div id="postTxtArea"></div>

          <div id="uploadOptionsBtns" class="post_sec_icons">
            <div>
              <div id="articleBtn" class="post_sec_icon">
                <img src="{% static 'img/article.png' %}" alt="article_icon" />
                <span style="color: #2f363a">Article</span>
              </div>
            </div>

            <input
              id="imgUploadInput"
              type="file"
              accept="image/*"
              style="display: none"
            />
            <div id="uploadImgBtn" class="post_sec_icon">
              <img src="{% static 'img/photo_icon.png' %}" alt="photo_icon" />
              <span>Photo</span>
            </div>

            <input
              id="vidUploadInput"
              type="file"
              accept="video/*"
              style="display: none"
            />
            <div id="uploadVidBtn" class="post_sec_icon">
              <img src="{% static 'img/video_icon.png' %}" alt="vid_icon" />
              <span>Video</span>
            </div>
          </div>
          <input type="submit" style="display: none" />
        </form>
        <div id="uploadPreview" style="display: none">
          <div id="imgPreview" style="display: none; position: relative">
            <div
              style="
                width: 25%;
                height: 100%;
                display: inline-block;
                position: absolute;
              "
            >
              <span id="removeSelectedImage">
                <img src="{% static 'img/delete_circle.png' %}" />
              </span>
            </div>
            <img id="uploadedImgPreview" width="25%" />
          </div>
          <div id="vidPreview" style="display: none; position: relative">
            <div
              style="
                width: 25%;
                height: 100%;
                position: absolute;
                display: flex;
                justify-content: flex-end;
                z-index: 2;
              "
            >
              <span id="removeSelectedVideo">
                <img src="{% static 'img/delete_circle.png' %}" />
              </span>
            </div>
            <video id="uploadedVidPreview" width="25%%" preload="metadata" />
          </div>
        </div>
        <div id="saveBtn">SAVE</div>
      </div>
      <div class="search_sec">
        <input
          type="text"
          name="search"
          class="search_input"
          placeholder="Search"
          id="search"
        />
        <div class="search_result">
          <span>Show Result</span>
          <span class="result_count">5</span>
        </div>
      </div>
      <div class="items_sec"></div>
    </div>

    <script src="{% static 'js/bootstrap-wysiwyg.js' %}"></script>

    <script src="{% static 'js/firebaseInit.js' %}"></script>

    <script>
      $(document).ready(() => {
        var month = new Array();
        month[0] = "January";
        month[1] = "February";
        month[2] = "March";
        month[3] = "April";
        month[4] = "May";
        month[5] = "June";
        month[6] = "July";
        month[7] = "August";
        month[8] = "September";
        month[9] = "October";
        month[10] = "November";
        month[11] = "December";

        let selectedPostForEdit = "";

        let selectedImgOrVid;
        let isSelectedImg = false;
        let storageRef = firebase.storage().ref();
        let database = firebase.database();
        let categoryID = "{{ categoryID | safe }}";

        let categoryPosts = "{{ categoryPosts | safe }}";
        categoryPosts = categoryPosts.replace(/'/g, '"');
        categoryPosts = categoryPosts.replace(/True/g, "true");
        categoryPosts = categoryPosts.replace(/\n/g, "\\n");

        categoryPosts = JSON.parse(categoryPosts);

        $("#postTxtArea").wysiwyg({
          toolbarSelector: "[data-role='post_text_toolbar']",
        });
        window.prettyPrint && prettyPrint();

        $("#articleBtn").click(() => {
          $("#postTxtArea").html("");
          $("#saveBtn").hide();
          $("#articleBtn").parent().toggleClass("active");
          if($("#articleBtn").parent().hasClass("active")) {
            $("#articleBtn").css("padding", "9px");
            $("#uploadImgBtn").addClass("disabled");
            $("#uploadVidBtn").addClass("disabled");
            $(".btn-toolbar").show();
          } else {
            $("#articleBtn").css("padding", "10px");
            $("#uploadImgBtn").removeClass("disabled");
            $("#uploadVidBtn").removeClass("disabled");
            $(".btn-toolbar").hide();
          }
        });

        $("#uploadImgBtn").click(() => {
          $("#imgUploadInput").click();
        });

        $("#uploadVidBtn").click(() => {
          $("#vidUploadInput").click();
        });

        $("#linkBtn").click(() => {
          $("#embedFormHeader").text("Embed Link");
          $("#embedLinkModal").show();
        });

        $("#embedImageBtn").click(() => {
          $("#embedFormHeader").text("Embed Image");
          $("#embedLinkModal").show();
        });

        $("#embedVideoBtn").click(() => {
          $("#embedFormHeader").text("Embed Video");
          $(".link_label").hide();
          $("#linkLabel").prop("required", false);
          $("#embedLinkModal").show();
        });

        $("#embedLinkForm").submit((e) => {
          e.preventDefault();
          if($("#embedFormHeader").text().indexOf("Link") > -1) {
            $("#postTxtArea").append("<a href=\"" + $("#link").val().trim() + "\">" + $("#linkLabel").val().trim() + "</a>");
          } else if($("#embedFormHeader").text().indexOf("Image") > -1) {
            $("#postTxtArea").append("<br><img src=\"" + $("#link").val().trim() + "\" alt=\"" + $("#linkLabel").val().trim() + "\"><br><br>");
          } else if($("#embedFormHeader").text().indexOf("Video") > -1) {
            $("#postTxtArea").append("<br><div style='text-align: center;'><video src=\"" + $("#link").val().trim() + "\" controls></video></div><br><br>");
            $(".link_label").show();
            $("#linkLabel").prop("required", true);
          }

          $("#link").val("");
          $("#linkLabel").val("");
          $("#embedLinkModal").hide();
        });

        $("#loaderPercen").show();

        let reader = new FileReader();
        $("#imgUploadInput").change(function(evt) {
          if (this.files && this.files[0]) {
            reader.onload = function(e) {
              $("#vidPreview").hide();
              $("#uploadOptionsBtns").hide();
              $("#uploadPreview").show();
              $("#imgPreview").show();
              $("#saveBtn").css("display", "flex");
              $("#uploadedImgPreview").attr("src", e.target.result);
            }
            reader.readAsDataURL(this.files[0]); // convert to base64 string

            selectedImgOrVid = this.files[0];
            isSelectedImg = true;
          }
        });

        $("#vidUploadInput").change(function() {
          if (this.files && this.files[0]) {
            reader.onload = function(e) {
              $("#imgPreview").hide();
              $("#uploadOptionsBtns").hide();
              $("#uploadPreview").show();
              $("#vidPreview").show();
              $("#saveBtn").css("display", "flex");
              $("#uploadedVidPreview").attr("src", e.target.result)

              document.getElementById("uploadedVidPreview").onloadedmetadata = function() {
                document.getElementById("uploadedVidPreview").currentTime = 0.5;
                document.getElementById("uploadedVidPreview").setAttribute('preload', "auto");
              };
            }
            reader.readAsDataURL(this.files[0]); // convert to base64 string

            selectedImgOrVid = this.files[0];
            isSelectedImg = false;
          }
        });

        $("#removeSelectedImage").click(() => {
          $("#uploadedImgPreview").removeAttr("src");
          $("#imgPreview").hide();
          $("#uploadPreview").hide();
          $("#imgUploadInput").val(null);
          $("#uploadOptionsBtns").show();

          selectedImgOrVid = null;

          if($("#postTxtArea").html().length == 0) {
            $("#saveBtn").hide();
          }

        });

        $("#removeSelectedVideo").click(() => {
          $("#uploadedVidPreview").removeAttr("src");
          $("#vidPreview").hide();
          $("#uploadPreview").hide();
          $("#vidUploadInput").val(null);
          $("#uploadOptionsBtns").show();

          selectedImgOrVid = null;

          if($("#postTxtArea").html().length == 0) {
            $("#saveBtn").hide();
          }
        });

        $(document).on("keyup", e => {
          console.log($(e.target).attr("id") == "postTxtArea");
          if($(e.target).attr("id") == "postTxtArea") {
            console.log($("#postTxtArea").html().length > 0);
            if($("#postTxtArea").html().length > 0) {
              console.log($("#saveBtn").css("display") == "none");
              if($("#saveBtn").css("display") == "none") {
                $("#saveBtn").css("display", "flex");
              }
            } else if ($("#postTxtArea").html().length == 0 && $("#uploadPreview").css("display") == "none") {
              $("#saveBtn").hide();
            }
          }
        });

        $("#saveBtn").click(() => {
          if(!$("#newPostForm")[0].checkValidity()) {
            $("#newPostForm input[type='submit']").click();
          } else {
            $("#loader").css("display", "flex");
            let postKey = selectedPostForEdit == "" ? database.ref().child('content/posts/').push().key : selectedPostForEdit;

            let postType = "";

            if($("#articleBtn").parent().hasClass("active")) {
              postType = "article";
            } else {
              if((selectedImgOrVid != null) && ($("#postTxtArea").html().length > 0) && isSelectedImg) {
                postType = "imgTxt";
              } else if((selectedImgOrVid != null) && ($("#postTxtArea").html().length > 0) && !isSelectedImg) {
                postType = "vidTxt";
              } else if((selectedImgOrVid != null) && !isSelectedImg) {
                postType = "vid";
              } else if((selectedImgOrVid != null) && isSelectedImg) {
                postType = "img";
              } else {
                postType = "txt";
              }
            }

            if(postType != "txt" && postType != "article") {
              let uploadTask = storageRef.child('content/posts/' + postKey + '.jpg').put(selectedImgOrVid);
              uploadTask.on('state_changed', function(snapshot){
                var progress = ((snapshot.bytesTransferred / snapshot.totalBytes) * 100).toFixed(2);
                $("#loaderPercen").text(progress + '%');

              }, function(error) {
                console.log(error);
                // Handle unsuccessful uploads
              }, function() {
                uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                  $.ajax({
                    type: "POST",
                    url: "{% url 'categoryDash' category_id='CATEGORY_ID' %}".replace(/CATEGORY_ID/, categoryID),
                    data: {
                      reqType : "add",
                      key : postKey,
                      type : postType,
                      name : $("#name").val(),
                      link : downloadURL,
                      text : $("#postTxtArea").html(),
                      timestamp : (new Date()).getTime(),
                      csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: (response) => {
                      if(response.result == "success") {
                        categoryPosts[response.postKey] = response.post;

                        $("#loader").hide();
                        isSelectedImg ? $("#uploadedImgPreview").removeAttr("src") : $("#uploadedVidPreview").removeAttr("src");
                        $("#vidPreview, #imgPreview").hide();
                        $("#uploadPreview").hide();
                        $("#imgUploadInput, #vidUploadInput").val(null);
                        $("#name").val("");
                        $("#postTxtArea").html("").show();
                        $("#uploadOptionsBtns").show();
                        $("#saveBtn").hide();
                        selectedImgOrVid = null;s

                        populatePostsList(true);
                      } else {
                        alert("Failed to add post!");
                        $("#loader").hide();
                      }
                    },
                    error: (xhr, errmsg, err) => {
                      console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                    }
                  });
                });
              });
            } else {
              $.ajax({
                type: "POST",
                url: "{% url 'categoryDash' category_id='CATEGORY_ID' %}".replace(/CATEGORY_ID/, categoryID),
                data: {
                  reqType : "add",
                  key : postKey,
                  type : postType,
                  name : $("#name").val(),
                  link : "",
                  text : $("#postTxtArea").html(),
                  textNoTags: $("#postTxtArea").text(),
                  timestamp : (new Date()).getTime(),
                  csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: (response) => {
                  if(response.result == "success") {
                    categoryPosts[response.postKey] = response.post;

                    $("#loader").hide();
                    isSelectedImg ? $("#uploadedImgPreview").removeAttr("src") : $("#uploadedVidPreview").removeAttr("src");
                    $("#vidPreview, #imgPreview").hide();
                    $("#uploadPreview").hide();
                    $("#imgUploadInput, #vidUploadInput").val(null);
                    $("#name").val("");
                    $("#postTxtArea").html("").show();
                    $("#uploadOptionsBtns").show();
                    $("#saveBtn").hide();
                    selectedImgOrVid = null;

                    populatePostsList();
                  } else {
                    alert("Failed to add post!");
                    $("#loader").hide();
                  }
                },
                error: (xhr, errmsg, err) => {
                  console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
              });
            }
          }
        });

        populatePostsList();

        function populatePostsList(){
          $(".items_sec").html("");

          let postIDs = Object.keys(categoryPosts);
          postIDs.reverse();

          postIDs.forEach((postID) => {
            let post = categoryPosts[postID];

            let item = document.createElement("div");
            item.classList.add("item");

            let itemContent = document.createElement("div");
            itemContent.classList.add("item_content");
            itemContent.setAttribute("data-item-content-post-id", postID);

            if(post.type == "txt") {
              itemContent.innerHTML += "<p>" + post.text + "</p>";
            } else if(post.type == "img") {
              itemContent.innerHTML += "<img src='" + post.link + "' width='40%' />";
            } else if(post.type == "vid") {
              itemContent.innerHTML += "<video src='" + post.link + "#t=0.5'  width='40%' preload='metadata' />";
            } else if(post.type == "imgTxt") {
              itemContent.innerHTML += "<img src='" + post.link + "' width='40%' /><span>" + post.text + "</span>";
            } else if(post.type == "vidTxt") {
              itemContent.innerHTML += "<video src='" + post.link + "#t=0.5'  width='40%' preload='metadata' /><span>" + post.text + "</span>";
            } else if(post.type == "article") {
              itemContent.innerHTML += "<p>" + post.text + "</p>";
            }

            let itemDate = document.createElement("span");
            itemDate.classList.add("item_date");

            let timestamp = new Date(parseInt(post.timestamp));

            itemDate.innerHTML = formatAMPM(timestamp) + "<br>" + timestamp.getDate() + " " + month[timestamp.getMonth()] + ", " + timestamp.getFullYear();

            let itemIcons = document.createElement("div");
            itemIcons.classList.add("item_icons");

            {% comment %} let editBtn = document.createElement("img");
            editBtn.setAttribute("src", "{% static 'img/edit_icon.png' %}");
            editBtn.setAttribute("alt", "edit");

            editBtn.addEventListener("click", () => {
              selectedPostForEdit = postID;
              if(post.type == "txt") {
                $("#postTxtArea").val($("[data-item-content-post-id='" + postID + "'] > p").html());
                $("#saveBtn").css("display", "flex");
              } else if(post.type == "img") {
                $("#vidPreview").hide();
                $("#uploadOptionsBtns").hide();
                $("#postTxtArea").show();
                $("#uploadPreview").show();
                $("#imgPreview").show();

                $("#uploadedImgPreview").attr("src", $("[data-item-content-post-id='" + postID + "'] > img").attr("src"));
              } else if(post.type == "vid") {
                $("#imgPreview").hide();
                $("#uploadOptionsBtns").hide();
                $("#postTxtArea").html("").hide();
                $("#uploadPreview").show();
                $("#vidPreview").show();
                $("#saveBtn").css("display", "flex");
                $("#uploadedVidPreview").attr("src", $("[data-item-content-post-id='" + postID + "'] > video").attr("src"))
              } else if(post.type == "imgTxt") {
                $("#vidPreview").hide();
                $("#uploadOptionsBtns").hide();
                $("#postTxtArea").show();
                $("#uploadPreview").show();
                $("#imgPreview").show();
                $("#saveBtn").css("display", "flex");
                $("#uploadedImgPreview").attr("src", $("[data-item-content-post-id='" + postID + "'] > img").attr("src"));

                $("#postTxtArea").val($("[data-item-content-post-id='" + postID + "'] > span").html());
              }
            }); {% endcomment %}

            let deleteBtn = document.createElement("img");
            deleteBtn.setAttribute("src", "{% static 'img/del_icon.png' %}");
            deleteBtn.setAttribute("alt", "delete");

            deleteBtn.addEventListener("click", () => {
              $("#loader").css("display", "flex");
              $.ajax({
                type: "POST",
                url: "{% url 'categoryDash' category_id='CATEGORY_ID' %}".replace(/CATEGORY_ID/, categoryID),
                data: {
                  reqType : "delete",
                  key : postID,
                  csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: (response) => {
                  $("#loader").hide();
                  if(response.result == "success") {
                    delete categoryPosts[response.postKey];

                    populatePostsList();
                  } else {
                    alert("Failed to add post!");
                  }
                },
                error: (xhr, errmsg, err) => {
                  $("#loader").hide();
                  console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
              });
            });

            {% comment %} itemIcons.appendChild(editBtn); {% endcomment %}
            itemIcons.appendChild(deleteBtn);

            item.appendChild(itemContent);
            item.appendChild(itemDate);
            item.appendChild(itemIcons);

            $(itemContent).html($(itemContent).text());

            document.getElementsByClassName("items_sec")[0].appendChild(item);
          });
        }

        function formatAMPM(date) {
          let hours = date.getHours();
          let minutes = date.getMinutes();
          let ampm = hours >= 12 ? 'PM' : 'AM';
          hours = hours % 12;
          hours = hours ? hours : 12; // the hour '0' should be '12'
          minutes = minutes < 10 ? '0'+minutes : minutes;
          var strTime = hours + ':' + minutes + ' ' + ampm;
          return strTime;
        }
      });
    </script>
  </body>
</html>
